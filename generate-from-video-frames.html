<div id="count"></div>
<script src="download2.js"></script>
<script>
    var canvasA = document.createElement('canvas'),
        contextA = canvasA.getContext('2d'),
        canvasB = document.createElement('canvas'),
        contextB = canvasB.getContext('2d'),
        canvasC = document.createElement('canvas'),
        contextC = canvasC.getContext('2d'),
        dataA,
        dataB,
        width,
        height,
        image,
        currentDiff,
        total = 0,
        count = 0,
        span = document.getElementById('count'),
        frame = 0;

    function calculateDifference() {
        var diff = 0,
            i;

        dataB = contextB.getImageData(0, 0, width, height).data;

        for (i = 0; i < dataA.length; i += 4) {
            //diff += Math.abs(dataB[i] - dataA[i]);
            diff += Math.sqrt(
                Math.pow(dataB[i+0] - dataA[i+0], 2) +
                Math.pow(dataB[i+1] - dataA[i+1], 2) +
                Math.pow(dataB[i+2] - dataA[i+2], 2)
            );
        }

        return diff;
    }

    function rand(min, max) {
        return Math.floor(Math.random()*(max-min)) + min;
    }

    function loop() {
        var r = rand(0, 256),
            g = rand(0, 256),
            b = rand(0, 256),
            size,
            newDiff,
            a;

        /*contextB.fillStyle = 'rgb('+r+','+g+','+b+')';
        contextB.fillRect(rand(-5, width), rand(-5, height), 5, 5);*/

        /*contextB.strokeStyle = 'rgb('+r+','+g+','+b+')';
        contextB.beginPath();
        contextB.moveTo(rand(-10, width), rand(-10, height));
        contextB.lineTo(rand(-10, width), rand(-10, height));
        contextB.stroke();*/

        size = ['20x20', '32x32', '64x64'][rand(0, 3)];
        var emojiImage = new Image();

        emojiImage.addEventListener('load', function () {
            contextB.drawImage(emojiImage, rand(-64, width), rand(-64, height));

            newDiff = calculateDifference();

            //console.log(newDiff, currentDiff);
            if (currentDiff - newDiff > 0) {
                //console.log('good');
                currentDiff = newDiff;
                contextC.drawImage(canvasB, 0, 0);

                count ++;
            }
            else {
                //console.log('bad');
                contextB.drawImage(canvasC, 0, 0);
            }

            total ++;
            span.innerHTML = count +' / '+ total;

            if (total > 10000) {
                canvasB.toBlob(function (blob) {
                    download(blob, 'emoji-video-' + ('00000'+frame).substr(-5) + '.png', 'image/png');

                    count = 0;
                    total = 0;

                    //setTimeout(loadNextFrame, 1000);
                    loadNextFrame();
                }, 'image/png');

                return;
            }

            setTimeout(loop, 0);
        });

        emojiImage.src = 'images/'+size+'/'+rand(1, 2175)+'.png';
    }

    function loadNextFrame() {
        frame ++;

        if (frame > 1200) {
            alert('done !!');
            return;
        }

        image = new Image();
        image.addEventListener('load', function () {
            var r, g, b, x, y;

            width = image.width;
            height = image.height;

            canvasA.width = width;
            canvasA.height = height;
            contextA.drawImage(image, 0, 0);

            if (frame == 1) {
                canvasB.width = width;
                canvasB.height = height;

                canvasC.width = width;
                canvasC.height = height;
                contextC.drawImage(canvasB, 0, 0);
            }

            dataA = contextA.getImageData(0, 0, width, height).data;

            currentDiff = calculateDifference();
            loop();
        });

        image.src = 'video/resized/' + ('0000000000'+frame).substr(-10) + '.png';
    }

    window.addEventListener('load', function () {
        document.body.appendChild(canvasA);
        //document.body.appendChild(canvasB);
        document.body.appendChild(canvasC);

        loadNextFrame();
    });
</script>
